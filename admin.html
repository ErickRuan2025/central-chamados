<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Facilita Assist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-recebido { border-left: 5px solid #3b82f6; }
        .status-aceito { border-left: 5px solid #22c55e; }
        .status-tecnico-a-caminho { border-left: 5px solid #f97316; }
        .status-finalizado { border-left: 5px solid #6b7280; }
        .status-cancelado { border-left: 5px solid #ef4444; }
    </style>
</head>
<body class="bg-gray-200 text-gray-800">

    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden"><div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4"><h3 id="notification-title" class="text-lg font-bold"></h3><p id="notification-message" class="mt-2 text-sm"></p><div class="mt-4 flex justify-end"><button onclick="closeModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Ok</button></div></div></div>

    <header class="bg-white shadow-md sticky top-0 z-10"><div class="container mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-20"><div class="flex items-center space-x-4"><img src="https://drive.google.com/uc?export=view&id=1L4yc0VdhoY_esmIZRABRcy9KOe3kwy86" alt="Logo Facilita Assist" class="h-12 w-auto" onerror="this.onerror=null; this.src='https://placehold.co/150x50/005A9C/FFFFFF?text=Facilita Assist';"><h1 class="text-2xl font-bold text-gray-900">Painel do Administrador</h1></div><div id="user-info" class="hidden"><button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Sair</button></div></div></header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div id="auth-section" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-center mb-6">Acesso Restrito</h2>
            <form id="login-form" class="space-y-4">
                <div><label for="login-email" class="block text-sm font-medium">Email:</label><input type="email" id="login-email" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                <div><label for="login-password" class="block text-sm font-medium">Senha:</label><input type="password" id="login-password" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 rounded-md shadow-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Entrar</button>
                <button type="button" id="forgot-password-button-admin" class="w-full text-center text-sm text-blue-600 hover:underline">Esqueceu a senha?</button>
            </form>
        </div>
        
        <div id="make-admin-section" class="hidden max-w-md mx-auto bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-6 rounded-lg shadow-lg" role="alert"><p class="font-bold text-lg">Permissão de Administrador Necessária</p><p class="mt-2">Esta conta não tem permissão de administrador. Se você é o proprietário, clique abaixo para conceder acesso a esta conta.</p><button id="make-admin-button" class="mt-4 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Tornar-se Administrador</button></div>

        <div id="app-content" class="hidden"><h2 class="text-2xl font-bold mb-4">Fila de Todos os Chamados</h2><div id="chamados-list" class="space-y-4"><div class="text-center py-10"><i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i><p class="mt-4 text-gray-500">Carregando...</p></div></div></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, updateDoc, getDocs, getDoc, setDoc, serverTimestamp, GeoPoint } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {"apiKey":"AIzaSyBIICQmfAMc-yNdXcyb6o9x5B9Yf3JzPos","authDomain":"facilita-assist-chamados.firebaseapp.com","projectId":"facilita-assist-chamados","storageBucket":"facilita-assist-chamados.appspot.com","messagingSenderId":"123881192310","appId":"1:123881192310:web:ed6dc6f7486ee1ccbbd857","measurementId":"G-V4PMT5HCFK"};
        const appId = 'central-chamados-default';
        const SOCIOS_WHATSAPP = [{ nome: "Erick Ruan", whatsapp: "5541992065641" }];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const ui = { authSection: document.getElementById('auth-section'), makeAdminSection: document.getElementById('make-admin-section'), appContent: document.getElementById('app-content'), userInfo: document.getElementById('user-info'), loginForm: document.getElementById('login-form'), logoutButton: document.getElementById('logout-button'), makeAdminButton: document.getElementById('make-admin-button'), forgotPasswordButton: document.getElementById('forgot-password-button-admin') };

        onAuthStateChanged(auth, async user => {
            if (user) {
                const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', user.uid);
                const adminSnap = await getDoc(adminRef);
                if (adminSnap.exists()) {
                    ui.authSection.classList.add('hidden');
                    ui.makeAdminSection.classList.add('hidden');
                    ui.appContent.classList.remove('hidden');
                    ui.userInfo.classList.remove('hidden');
                    listenToAllChamados();
                } else {
                    ui.authSection.classList.add('hidden');
                    ui.makeAdminSection.classList.remove('hidden');
                }
            } else {
                ui.authSection.classList.remove('hidden');
                ui.makeAdminSection.classList.add('hidden');
                ui.appContent.classList.add('hidden');
                ui.userInfo.classList.add('hidden');
            }
        });

        ui.loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); } 
            catch (error) { showModal("Erro no Login", "Email ou senha inválidos."); }
        });

        ui.forgotPasswordButton.addEventListener('click', () => {
             const email = prompt("Insira o e-mail da conta de administrador:");
            if (email) { sendPasswordResetEmail(auth, email).then(() => showModal("E-mail Enviado", "Link enviado para " + email)).catch(error => showModal("Erro", "E-mail não encontrado.")); }
        });
        
        ui.makeAdminButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) { showModal("Erro", "Usuário não encontrado."); return; }
            const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', user.uid);
            try { await setDoc(adminRef, { admin: true, email: user.email }); showModal("Sucesso!", "Você agora é um administrador."); setTimeout(() => window.location.reload(), 2000); } 
            catch (error) { showModal("Erro ao criar Admin", error.message); }
        });
        
        ui.logoutButton.addEventListener('click', () => signOut(auth));

        function listenToAllChamados() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chamados'));
            onSnapshot(q, snapshot => {
                const chamados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderChamados(chamados.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)));
            });
        }
        
        window.aceitarChamado = async (docId) => {
            const chamadosCollection = collection(db, 'artifacts', appId, 'public', 'data', 'chamados');
            const q = query(chamadosCollection);
            const querySnapshot = await getDocs(q);
            const maxOS = Math.max(1000, ...querySnapshot.docs.map(d => d.data().os || 0));
            await updateDoc(doc(chamadosCollection, docId), { status: 'Aceito', os: maxOS + 1 });
            showModal("Sucesso!", `Chamado aceito! O.S. Nº ${maxOS + 1} gerada.`);
        };
        
        window.enviarLocalizacao = (docId) => {
            if (!navigator.geolocation) { showModal("Erro", "Geolocalização não é suportada por este navegador."); return; }
            showModal("Localização", "Obtendo sua localização... Por favor, aprove a permissão no navegador.");
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                const chamadoRef = doc(db, 'artifacts', appId, 'public', 'data', 'chamados', docId);
                await updateDoc(chamadoRef, { tecnicoLocation: new GeoPoint(latitude, longitude) });
                showModal("Sucesso!", "Localização enviada ao cliente.");
            }, () => { showModal("Erro", "Não foi possível obter sua localização. Verifique as permissões."); });
        };

        window.atualizarStatus = async (docId, newStatus) => {
            const chamadoRef = doc(db, 'artifacts', appId, 'public', 'data', 'chamados', docId);
            let updateData = { status: newStatus };

            if (newStatus === 'Técnico a caminho') {
                const nomeTecnico = prompt("Por favor, insira o nome do técnico:");
                if (nomeTecnico) {
                    updateData.nomeTecnico = nomeTecnico;
                } else {
                    showModal("Ação cancelada", "O nome do técnico não foi inserido.");
                    window.location.reload(); // Recarrega para resetar o select
                    return; 
                }
            }

            if (newStatus === 'Finalizado') {
                updateData.dataFinalizacao = serverTimestamp();
            }

            await updateDoc(chamadoRef, updateData);
            showModal("Status Atualizado", `O chamado agora está como "${newStatus}".`);
        };

        function getAcaoPrincipalButton(c) {
            if (c.status === 'Chamado Recebido') {
                return `<button onclick="aceitarChamado('${c.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center justify-center gap-2"><i class="fas fa-check"></i> Aceitar</button>`;
            } 
            if (c.status === 'Aceito' || c.status === 'Técnico a caminho') {
                const subject = `✅ Chamado Aceito (OS: ${c.os}) - Facilita Assist`;
                const body = [`Olá, ${c.nome}!`, ``, `Ótima notícia! Sua solicitação de serviço de "${c.categoria}" foi aceita por nossa equipe.`, ``, `A sua Ordem de Serviço (O.S.) para acompanhamento é:`, `${c.os}`, ``, `Em breve, um de nossos técnicos entrará em contato.`, ``, `Agradecemos a sua confiança!`, ``, `Equipe Facilita Assist`].join("\n");
                const mailtoLink = `mailto:${c.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                return `<a href="${mailtoLink}" target="_blank" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center justify-center gap-2"><i class="fas fa-envelope"></i> Notificar Cliente</a>`;
            }
            return `<div class="flex-1"></div>`;
        }

        function renderChamados(chamados) {
            const list = document.getElementById('chamados-list');
            if (chamados.length === 0) { list.innerHTML = `<div class="text-center py-10 bg-white rounded-lg shadow"><i class="fas fa-check-circle fa-3x text-green-400"></i><p class="mt-4 text-gray-600">Nenhum chamado na fila.</p></div>`; return; }
            list.innerHTML = chamados.map(c => {
                 const data = c.timestamp ? c.timestamp.toDate().toLocaleString('pt-BR') : 'N/A';
                 const statusClass = `status-${c.status.toLowerCase().replace(/\s+/g, '-')}`;
                 let statusText = c.os ? `OS: ${c.os} - ${c.status}` : c.status;
                 if (c.status === 'Finalizado' && c.dataFinalizacao) {
                    statusText = `Finalizado em: ${c.dataFinalizacao.toDate().toLocaleDateString('pt-BR')}`;
                 }
                 const acaoPrincipalButton = getAcaoPrincipalButton(c);
                 const whatsappLinksHtml = SOCIOS_WHATSAPP.map(socio => `<a href="https://wa.me/${socio.whatsapp}?text=${encodeURIComponent(`Chamado Recebido!\nCliente: ${c.nome}\nTelefone: ${c.telefone}\nEndereço: ${c.endereco}\nCategoria: ${c.categoria}\nDetalhes: ${c.detalhes}`)}" target="_blank" class="flex-1 bg-green-100 text-green-800 hover:bg-green-200 font-semibold py-2 px-3 rounded-lg text-xs flex items-center justify-center gap-1.5"><i class="fab fa-whatsapp"></i> ${socio.nome}</a>`).join('');
                 const locationButton = `<button id="location-btn-${c.id}" onclick="enviarLocalizacao('${c.id}')" class="ml-2 bg-orange-500 hover:bg-orange-600 text-white font-bold py-1 px-2 rounded-md text-xs ${c.status !== 'Técnico a caminho' ? 'hidden' : ''}"><i class="fas fa-map-marker-alt"></i> Enviar Localização</button>`;
                 const tecnicoInfo = c.nomeTecnico ? `<div><strong class="block">Técnico:</strong> <span>${c.nomeTecnico}</span></div>` : '';

                 return `<div class="bg-white rounded-lg shadow-md p-5 ${statusClass}"><div class="flex flex-col sm:flex-row justify-between sm:items-center border-b pb-3 mb-3"><div><h3 class="font-bold text-lg">${c.nome}</h3><p class="text-sm text-gray-500">${c.categoria}</p></div><div class="mt-2 sm:mt-0 flex items-center justify-end space-x-3"><span class="text-xs font-semibold text-white px-3 py-1 rounded-full ${c.status==='Chamado Recebido'?'bg-blue-500':c.status==='Aceito'?'bg-green-500': c.status === 'Técnico a caminho' ? 'bg-orange-500' : c.status==='Finalizado'?'bg-gray-500':'bg-red-500'}">${statusText}</span><span class="text-xs text-gray-400">${data}</span></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4"><div><strong class="block">Email:</strong> <span>${c.email}</span></div><div><strong class="block">Telefone:</strong> <span>${c.telefone}</span></div><div class="md:col-span-2"><strong class="block">Endereço:</strong> <span>${c.endereco}</span></div>${tecnicoInfo}<div class="md:col-span-2"><strong class="block">Detalhes:</strong> <p class="mt-1 p-2 bg-gray-50 rounded-md">${c.detalhes}</p></div></div><div class="flex flex-col sm:flex-row items-center gap-3 pt-3 border-t">${acaoPrincipalButton}<div class="flex-1 flex justify-end gap-2">${whatsappLinksHtml}</div></div><div class="mt-3 flex items-center"><select onchange="atualizarStatus('${c.id}', this.value)" class="w-full sm:w-auto bg-gray-200 border-gray-300 rounded-md shadow-sm text-sm"><option value="" disabled ${!c.status?'selected':''}>Mudar status...</option><option value="Chamado Recebido" ${c.status==='Chamado Recebido'?'selected':''}>Recebido</option><option value="Aceito" ${c.status==='Aceito'?'selected':''}>Aceito</option><option value="Técnico a caminho" ${c.status==='Técnico a caminho'?'selected':''}>Técnico a caminho</option><option value="Finalizado" ${c.status==='Finalizado'?'selected':''}>Finalizado</option><option value="Cancelado" ${c.status==='Cancelado'?'selected':''}>Cancelado</option></select>${locationButton}</div></div>`;
            }).join('');
        }
        
        window.showModal = (title, message) => { document.getElementById('notification-title').textContent = title; document.getElementById('notification-message').textContent = message; document.getElementById('notification-modal').classList.remove('hidden'); }
        window.closeModal = () => { document.getElementById('notification-modal').classList.add('hidden'); }
    </script>
</body>
</html>
