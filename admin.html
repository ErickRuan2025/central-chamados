<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Facilita Assist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-recebido { border-left: 5px solid #3b82f6; }
        .status-aceito { border-left: 5px solid #22c55e; }
        .status-finalizado { border-left: 5px solid #6b7280; }
        .status-cancelado { border-left: 5px solid #ef4444; }
    </style>
</head>
<body class="bg-gray-200 text-gray-800">

    <!-- Modal -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4"><h3 id="notification-title" class="text-lg font-bold"></h3><p id="notification-message" class="mt-2 text-sm"></p><div class="mt-4 flex justify-end"><button onclick="closeModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Ok</button></div></div>
    </div>
    
    <!-- Cabeçalho -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-20">
            <div class="flex items-center space-x-4">
                 <img src="https://drive.google.com/uc?export=view&id=1L4yc0VdhoY_esmIZRABRcy9KOe3kwy86" alt="Logo Facilita Assist" class="h-12 w-auto" onerror="this.onerror=null; this.src='https://placehold.co/150x50/005A9C/FFFFFF?text=Facilita Assist';">
                <h1 class="text-2xl font-bold text-gray-900">Painel do Administrador</h1>
            </div>
            <div id="user-info" class="hidden"><button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Sair</button></div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Login Admin -->
        <div id="auth-section" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-center mb-6">Acesso Restrito</h2>
            <form id="login-form" class="space-y-4">
                <div><label for="login-email" class="block text-sm font-medium">Email:</label><input type="email" id="login-email" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                <div><label for="login-password" class="block text-sm font-medium">Senha:</label><input type="password" id="login-password" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Entrar</button>
            </form>
        </div>
        
        <!-- Conteúdo Admin -->
        <div id="app-content" class="hidden">
            <h2 class="text-2xl font-bold mb-4">Fila de Todos os Chamados</h2>
            <div id="chamados-list" class="space-y-4">
                <div class="text-center py-10"><i class="fas fa-spinner fa-spin fa-3x text-gray-400"></i><p class="mt-4 text-gray-500">Carregando...</p></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, updateDoc, getDocs, getDoc, serverTimestamp, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIICQmfAMc-yNdXcyb6o9x5B9Yf3JzPos",
            authDomain: "facilita-assist-chamados.firebaseapp.com",
            projectId: "facilita-assist-chamados",
            storageBucket: "facilita-assist-chamados.appspot.com",
            messagingSenderId: "123881192310",
            appId: "1:123881192310:web:ed6dc6f7486ee1ccbbd857",
            measurementId: "G-V4PMT5HCFK"
        };
        const appId = 'central-chamados-default';
        const URL_LOGO_EMPRESA = "https://drive.google.com/uc?export=view&id=1L4yc0VdhoY_esmIZRABRcy9KOe3kwy86";
        const SOCIOS_WHATSAPP = [{ nome: "Erick Ruan", whatsapp: "5541992065641" }];


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const userInfo = document.getElementById('user-info');
        const loginForm = document.getElementById('login-form');

        // Monitora o estado de autenticação
        onAuthStateChanged(auth, async user => {
            if (user) {
                // VERIFICA SE O USUÁRIO É ADMIN
                const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', user.uid);
                const adminSnap = await getDoc(adminRef);

                if (adminSnap.exists()) {
                    authSection.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    userInfo.classList.remove('hidden');
                    listenToAllChamados();
                } else {
                    signOut(auth);
                    showModal("Acesso Negado", "Este usuário não tem permissão de administrador.");
                }
            } else {
                authSection.classList.remove('hidden');
                appContent.classList.add('hidden');
                userInfo.classList.add('hidden');
            }
        });

        // Login do Admin
        loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showModal("Erro no Login", "Email ou senha inválidos.");
            }
        });
        
        // Logout
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

        // Ouvir todos os chamados
        function listenToAllChamados() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chamados'));
            onSnapshot(q, snapshot => {
                const chamados = [];
                snapshot.forEach(doc => chamados.push({ id: doc.id, ...doc.data() }));
                chamados.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderChamados(chamados);
            });
        }
        
        // Aceitar chamado
        window.aceitarChamado = async function(docId) {
            try {
                const chamadosRef = collection(db, 'artifacts', appId, 'public', 'data', 'chamados');
                const q = query(chamadosRef);
                const querySnapshot = await getDocs(q);
                let maxOS = 1000;
                querySnapshot.forEach(doc => {
                    const os = doc.data().os;
                    if (os && os > maxOS) maxOS = os;
                });
                const newOS = maxOS + 1;
                const chamadoRef = doc(db, 'artifacts', appId, 'public', 'data', 'chamados', docId);
                await updateDoc(chamadoRef, { status: 'Aceito', os: newOS });
                showModal("Sucesso!", `Chamado aceito! A O.S. Nº ${newOS} foi gerada.`);
            } catch (error) {
                showModal("Erro", "Não foi possível aceitar o chamado. " + error.message);
            }
        }
        
        // Atualizar status
        window.atualizarStatus = async function(docId, newStatus) {
            const chamadoRef = doc(db, 'artifacts', appId, 'public', 'data', 'chamados', docId);
            await updateDoc(chamadoRef, { status: newStatus });
            showModal("Status Atualizado", `O chamado agora está como "${newStatus}".`);
        }

        // Renderizar UI Admin
        function renderChamados(chamados) {
            const list = document.getElementById('chamados-list');
            if (chamados.length === 0) {
                list.innerHTML = `<div class="text-center py-10 bg-white rounded-lg shadow"><i class="fas fa-check-circle fa-3x text-green-400"></i><p class="mt-4 text-gray-600">Nenhum chamado na fila. Tudo em ordem!</p></div>`;
                return;
            }
            list.innerHTML = chamados.map(c => {
                 const data = c.timestamp ? c.timestamp.toDate().toLocaleString('pt-BR') : 'N/A';
                 const statusClass = `status-${c.status.toLowerCase().replace(' ', '-')}`;

                let acaoPrincipalButton;
                if (c.status === 'Chamado Recebido') {
                    acaoPrincipalButton = `<button onclick="aceitarChamado('${c.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center justify-center gap-2"><i class="fas fa-check"></i> Aceitar</button>`;
                } else if (c.status === 'Aceito') {
                    const subject = `✅ Chamado Aceito, ${c.nome}! Sua O.S. é a Nº ${c.os}`;
                    const body = `Olá, ${c.nome}!\n\nÓtima notícia! Sua solicitação de serviço de ${c.categoria} foi aceita por nossa equipe.\nA sua Ordem de Serviço (O.S.) para acompanhamento é: ${c.os}\n\nEm breve, um de nossos técnicos entrará em contato para confirmar a melhor data e horário para a visita.\n\nAgradecemos a sua confiança!\n\nAtenciosamente,\nEquipe Facilita Assist`;
                    const mailtoLink = `mailto:${c.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    acaoPrincipalButton = `<a href="${mailtoLink}" target="_blank" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center justify-center gap-2"><i class="fas fa-envelope"></i> Notificar Cliente (OS: ${c.os})</a>`;
                } else {
                     acaoPrincipalButton = `<div class="flex-1"></div>`;
                }

                let whatsappLinksHtml = SOCIOS_WHATSAPP.map(socio => {
                    const baseMessage = `Chamado Recebido!\n------------------\nCliente: ${c.nome}\nTelefone: ${c.telefone}\nEndereço: ${c.endereco}\nCategoria: ${c.categoria}\nDetalhes: ${c.detalhes}`;
                    const whatsappLink = `https://wa.me/${socio.whatsapp}?text=${encodeURIComponent(baseMessage)}`;
                    return `<a href="${whatsappLink}" target="_blank" class="flex-1 bg-green-100 text-green-800 hover:bg-green-200 font-semibold py-2 px-3 rounded-lg text-xs flex items-center justify-center gap-1.5"><i class="fab fa-whatsapp"></i> ${socio.nome}</a>`;
                }).join('');

                 return `<div class="bg-white rounded-lg shadow-md p-5 ${statusClass}">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center border-b pb-3 mb-3">
                            <div><h3 class="font-bold text-lg">${c.nome}</h3><p class="text-sm text-gray-500">${c.categoria}</p></div>
                            <div class="mt-2 sm:mt-0 flex items-center justify-end space-x-3">
                               <span class="text-xs font-semibold text-white px-3 py-1 rounded-full ${c.status === 'Chamado Recebido' ? 'bg-blue-500' : c.status === 'Aceito' ? 'bg-green-500' : c.status === 'Finalizado' ? 'bg-gray-500' : 'bg-red-500'}">${c.status}</span>
                               <span class="text-xs text-gray-400">${data}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
                            <div><strong class="block">Email:</strong> <span>${c.email}</span></div>
                            <div><strong class="block">Telefone:</strong> <span>${c.telefone}</span></div>
                            <div class="md:col-span-2"><strong class="block">Endereço:</strong> <span>${c.endereco}</span></div>
                            <div class="md:col-span-2"><strong class="block">Detalhes:</strong> <p class="mt-1 p-2 bg-gray-50 rounded-md">${c.detalhes}</p></div>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-3 pt-3 border-t">
                             ${acaoPrincipalButton}
                            <div class="flex-1 flex justify-end gap-2">${whatsappLinksHtml}</div>
                        </div>
                         <div class="mt-3">
                            <select onchange="atualizarStatus('${c.id}', this.value)" class="w-full sm:w-auto bg-gray-200 border-gray-300 rounded-md shadow-sm text-sm">
                                <option value="" disabled ${!c.status ? 'selected' : ''}>Mudar status...</option>
                                <option value="Chamado Recebido" ${c.status === 'Chamado Recebido' ? 'selected' : ''}>Recebido</option>
                                <option value="Aceito" ${c.status === 'Aceito' ? 'selected' : ''}>Aceito</option>
                                <option value="Finalizado" ${c.status === 'Finalizado' ? 'selected' : ''}>Finalizado</option>
                                <option value="Cancelado" ${c.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                            </select>
                        </div>
                    </div>`;
            }).join('');
        }

        // Modal
        window.showModal = function(title, message) {
            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;
            document.getElementById('notification-modal').classList.remove('hidden');
        }
        window.closeModal = function() {
            document.getElementById('notification-modal').classList.add('hidden');
        }

        // Função para criar o primeiro admin (executar uma vez no console do navegador)
        window.criarPrimeiroAdmin = function() {
            console.log("Para criar o primeiro admin, faça login com a conta que deseja tornar administradora e depois execute no console: `const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', auth.currentUser.uid); await setDoc(adminRef, { admin: true });`");
        }

    </script>
</body>
</html>
